name: Build Shelly Driver Library Bundle

on:
  push:
    branches: ["master"]
    paths:
      - ShellyDriverLibrary/ShellyUSA.ShellyUSA_Driver_Library.groovy
  workflow_dispatch:

jobs:
  build:
    name: Build and Bundle Shelly Driver Library
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get library version
        id: lib_version
        run: |
          # Extract library version from library file's version comment
          LIB_VERSION=$(grep -m 1 "Version:" ShellyDriverLibrary/*.groovy | sed -n 's/.*Version: \([0-9.]*\).*/\1/p' || echo "2.0.0")
          echo "library_version=$LIB_VERSION" >> $GITHUB_OUTPUT
          echo "Library version: $LIB_VERSION"

      - name: Create library bundle
        run: |
          LIB_VERSION="${{ steps.lib_version.outputs.library_version }}"
          echo "Creating Shelly Driver Library bundle v$LIB_VERSION..."
          cd ShellyDriverLibrary
          # Create versioned bundle
          zip -r ../ShellyUSA_Driver_Library-v${LIB_VERSION}.zip *.groovy *.txt
          # Also create unversioned bundle for backward compatibility
          zip -r ../ShellyUSA_Driver_Library.zip *.groovy *.txt
          cd ..
          echo "Bundles created successfully"

      - name: Verify bundle
        run: |
          LIB_VERSION="${{ steps.lib_version.outputs.library_version }}"
          if [ -f "ShellyUSA_Driver_Library-v${LIB_VERSION}.zip" ]; then
            echo "Versioned bundle file created: ShellyUSA_Driver_Library-v${LIB_VERSION}.zip"
            unzip -l ShellyUSA_Driver_Library-v${LIB_VERSION}.zip
          else
            echo "ERROR: Versioned bundle file not created!"
            exit 1
          fi

      - name: Commit and push bundle
        uses: EndBug/add-and-commit@v9
        with:
          add: |
            ShellyUSA_Driver_Library*.zip
          message: "Update Shelly Driver Library bundle v${{ steps.lib_version.outputs.library_version }}"
          default_author: github_actions
